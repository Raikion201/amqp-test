/*
 * Adapted from Apache ActiveMQ Artemis AMQP protocol tests.
 * Licensed under the Apache License, Version 2.0
 */
package com.amqp.protocol.v10.transport;

import com.amqp.protocol.v10.types.Symbol;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.DisplayName;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import static org.junit.jupiter.api.Assertions.*;

/**
 * Tests for AMQP 1.0 Open performative.
 * Adapted from Apache ActiveMQ Artemis OpenTest.
 */
@DisplayName("AMQP 1.0 Open Performative Tests")
public class OpenTest {

    @Test
    @DisplayName("Open: Container ID is required")
    void testContainerIdRequired() {
        assertThrows(NullPointerException.class, () -> new Open(null));
    }

    @Test
    @DisplayName("Open: Should have correct descriptor")
    void testDescriptor() {
        Open open = new Open("test-container");
        assertEquals(0x10L, open.getDescriptor());
    }

    @Test
    @DisplayName("Open: Should store container ID")
    void testContainerId() {
        String containerId = "my-container-id";
        Open open = new Open(containerId);
        assertEquals(containerId, open.getContainerId());
    }

    @Test
    @DisplayName("Open: Should have default max frame size")
    void testDefaultMaxFrameSize() {
        Open open = new Open("test");
        assertEquals(Open.DEFAULT_MAX_FRAME_SIZE, open.getMaxFrameSize());
    }

    @Test
    @DisplayName("Open: Should have default channel max")
    void testDefaultChannelMax() {
        Open open = new Open("test");
        assertEquals(Open.DEFAULT_CHANNEL_MAX, open.getChannelMax());
    }

    @Test
    @DisplayName("Open: Should have default idle timeout")
    void testDefaultIdleTimeout() {
        Open open = new Open("test");
        assertEquals(Open.DEFAULT_IDLE_TIMEOUT, open.getIdleTimeout());
    }

    @Test
    @DisplayName("Open: Should set hostname")
    void testSetHostname() {
        Open open = new Open("test")
                .setHostname("localhost");
        assertEquals("localhost", open.getHostname());
    }

    @Test
    @DisplayName("Open: Should set max frame size")
    void testSetMaxFrameSize() {
        Open open = new Open("test")
                .setMaxFrameSize(65536);
        assertEquals(65536, open.getMaxFrameSize());
    }

    @Test
    @DisplayName("Open: Should set channel max")
    void testSetChannelMax() {
        Open open = new Open("test")
                .setChannelMax(100);
        assertEquals(100, open.getChannelMax());
    }

    @Test
    @DisplayName("Open: Should set idle timeout")
    void testSetIdleTimeout() {
        Open open = new Open("test")
                .setIdleTimeout(30000);
        assertEquals(30000, open.getIdleTimeout());
    }

    @Test
    @DisplayName("Open: Should set outgoing locales")
    void testSetOutgoingLocales() {
        Symbol[] locales = {Symbol.valueOf("en-US"), Symbol.valueOf("de-DE")};
        Open open = new Open("test")
                .setOutgoingLocales(locales);
        assertArrayEquals(locales, open.getOutgoingLocales());
    }

    @Test
    @DisplayName("Open: Should set incoming locales")
    void testSetIncomingLocales() {
        Symbol[] locales = {Symbol.valueOf("en-US")};
        Open open = new Open("test")
                .setIncomingLocales(locales);
        assertArrayEquals(locales, open.getIncomingLocales());
    }

    @Test
    @DisplayName("Open: Should set offered capabilities")
    void testSetOfferedCapabilities() {
        Symbol[] capabilities = {
                Symbol.valueOf("ANONYMOUS-RELAY"),
                Symbol.valueOf("DELAYED-DELIVERY")
        };
        Open open = new Open("test")
                .setOfferedCapabilities(capabilities);
        assertArrayEquals(capabilities, open.getOfferedCapabilities());
    }

    @Test
    @DisplayName("Open: Should set desired capabilities")
    void testSetDesiredCapabilities() {
        Symbol[] capabilities = {Symbol.valueOf("ANONYMOUS-RELAY")};
        Open open = new Open("test")
                .setDesiredCapabilities(capabilities);
        assertArrayEquals(capabilities, open.getDesiredCapabilities());
    }

    @Test
    @DisplayName("Open: Should set properties")
    void testSetProperties() {
        Map<Symbol, Object> properties = new HashMap<>();
        properties.put(Symbol.valueOf("product"), "AMQP Server");
        properties.put(Symbol.valueOf("version"), "1.0.0");

        Open open = new Open("test")
                .setProperties(properties);

        assertEquals(properties, open.getProperties());
    }

    @Test
    @DisplayName("Open: Builder pattern should be chainable")
    void testBuilderChaining() {
        Open open = new Open("container")
                .setHostname("host")
                .setMaxFrameSize(1024)
                .setChannelMax(10)
                .setIdleTimeout(5000);

        assertEquals("container", open.getContainerId());
        assertEquals("host", open.getHostname());
        assertEquals(1024, open.getMaxFrameSize());
        assertEquals(10, open.getChannelMax());
        assertEquals(5000, open.getIdleTimeout());
    }

    @Test
    @DisplayName("Open: getFields should return only container ID when defaults used")
    void testGetFieldsWithDefaults() {
        Open open = new Open("test");
        List<Object> fields = open.getFields();

        assertEquals(1, fields.size());
        assertEquals("test", fields.get(0));
    }

    @Test
    @DisplayName("Open: getFields should include all non-null values")
    void testGetFieldsWithValues() {
        Open open = new Open("test")
                .setHostname("host")
                .setMaxFrameSize(1024);

        List<Object> fields = open.getFields();

        assertTrue(fields.size() >= 3);
        assertEquals("test", fields.get(0));
        assertEquals("host", fields.get(1));
        // max-frame-size is UInt per AMQP 1.0 spec
        Object maxFrameSize = fields.get(2);
        if (maxFrameSize instanceof com.amqp.protocol.v10.types.UInt) {
            assertEquals(1024L, ((com.amqp.protocol.v10.types.UInt) maxFrameSize).longValue());
        } else {
            assertEquals(1024L, maxFrameSize);
        }
    }

    @Test
    @DisplayName("Open: toString should include key fields")
    void testToString() {
        Open open = new Open("my-container")
                .setHostname("localhost")
                .setMaxFrameSize(65536);

        String str = open.toString();

        assertTrue(str.contains("my-container"));
        assertTrue(str.contains("localhost"));
        assertTrue(str.contains("65536"));
    }

    @Test
    @DisplayName("Open: Should handle null hostname")
    void testNullHostname() {
        Open open = new Open("test");
        assertNull(open.getHostname());
    }

    @Test
    @DisplayName("Open: Should handle null capabilities")
    void testNullCapabilities() {
        Open open = new Open("test");
        assertNull(open.getOfferedCapabilities());
        assertNull(open.getDesiredCapabilities());
    }

    @Test
    @DisplayName("Open: Should handle null properties")
    void testNullProperties() {
        Open open = new Open("test");
        assertNull(open.getProperties());
    }
}
